import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
import mysql.connector
from mysql.connector import errorcode
import time
import os
from pathlib import Path
import os.path
import functools
import operator
from datetime import datetime


class Connection():
    def __init__(self):
        pass

    def _ClearTerminal(self):
        if os.name == 'nt':  # Windows
            os.system('cls')
        elif os.name == 'posix':  # Mac or Linux
            os.system('clear')

    def _ConnectionDetails(self):
        Flag = False
        host = input("Enter host name: ")
        UserName = input("Enter username: ")
        PassWord = input("Enter password: ")
        while Flag == False:
            try:
                self._ClearTerminal()
                con = mysql.connector.connect(
                    host=host,
                    user=UserName,
                    password=PassWord
                )
                Flag = True
                con.close()
            except mysql.connector.Error as err:
                if err.errno == errorcode.ER_ACCESS_DENIED_ERROR:
                    self._ClearTerminal()
                    print("INCORRECT USERNAME OR PASSWORD")
                    time.sleep(0.5)
                else:
                    self._ClearTerminal()
                    print(err)
                    time.sleep(0.5)
            con.close()
        time.sleep(0.5)
        self._ClearTerminal()
        Details = [host, UserName, PassWord]
        return Details


class ConnectionFile(Connection):
    def __init__(self):
        super().__init__()

    def ConnectionFileReading(self):
        base_folder = Path(__file__).parent.resolve()
        connnectiondetails = base_folder / "connectiondetails.txt"
        if os.path.isfile(connnectiondetails):
            text_file = open(connnectiondetails, "r")
            details = text_file.read().split(',')
        else:
            details = super()._ConnectionDetails()
            with open(connnectiondetails, 'w') as f:
                f.write(details[0] + ",")
                f.write(details[1] + ",")
                f.write(details[2])
        return details


class Login(ConnectionFile):
    def __init__(self):
        super().__init__()

    def Login(self):
        Result = []
        while len(Result) == 0:
            Details = super().ConnectionFileReading()
            self.BMFAID = input('Enter BMFA id: ')
            self.Name = input("Enter name: ")
            self.Password = input('Enter password: ')
            con = mysql.connector.connect(host=Details[0], user=Details[1], password=Details[2])
            cursor = con.cursor()
            LoginDetails = [self.BMFAID, self.Name, self.Password]
            SQL = "Select Table_SCHEMA FROM information_schema.COLUMNS WHERE TABLE_NAME = 'SensorData' LIMIT 1"
            con = mysql.connector.connect(host=Details[0], user=Details[1], password=Details[2])
            cursor = con.cursor()
            cursor.execute(SQL)
            database = cursor.fetchone()
            SQL = """SELECT Admin FROM """ + functools.reduce(operator.add, database[
                0]) + ".Users" + """ WHERE BMFAID = %s AND Username = %s AND Password = %s"""
            cursor.execute(SQL, LoginDetails)
            Result = cursor.fetchall()
            cursor.close()
            con.close()
            super()._ClearTerminal()
            if len(Result) <= 0:
                print("Incorrect BMFAID or Incorrect Name or Incorrect Password")
                time.sleep(1)
                super()._ClearTerminal()
        con = mysql.connector.connect(host=Details[0], user=Details[1], password=Details[2])
        cursor = con.cursor()
        SQL = """SELECT SerialID FROM """ + functools.reduce(operator.add, database[
            0]) + """.Users""" + """ WHERE BMFAID = %s AND Username = %s AND Password = %s"""
        cursor.execute(SQL, LoginDetails)
        SerialID = cursor.fetchone()
        SQL = """SELECT RaspberryPiID FROM """ + functools.reduce(operator.add, database[
            0]) + """.Users""" + """ WHERE BMFAID = %s AND Username = %s AND Password = %s"""
        cursor.execute(SQL, LoginDetails)
        RaspberryPiID = cursor.fetchone()
        SQL = """SELECT Admin FROM """ + functools.reduce(operator.add, database[
            0]) + """.Users""" + """ WHERE BMFAID = %s AND Username = %s AND Password = %s"""
        cursor.execute(SQL, LoginDetails)
        Admin = cursor.fetchone()
        cursor.close()
        con.close()
        LoginDetails = [SerialID, RaspberryPiID, Admin]
        return LoginDetails


class DataBaseLocation(Login):
    def __init__(self):
        super().__init__()

    def _ChoosingGPSTable(self, host, database, UserName, Password, Admin):
        table1 = ""
        Flag = False
        while Flag == False:
            super()._ClearTerminal()
            SQL = "SELECT DISTINCT TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = " + "'" + functools.reduce(
                operator.add, database) + "'" + ";"
            con = mysql.connector.connect(host=host, user=UserName, password=Password)
            cursor = con.cursor()
            cursor.execute(SQL)
            Details = cursor.fetchall()
            for i in range(0, len(Details)):
                print(str(i + 1) + ") " + functools.reduce(operator.add, Details[i]))
            cursor.close()
            con.close()
            UC = input("Choose table for GPS data to be taken from or enter X to retun to previous page: ")
            if UC.isnumeric() == True:
                if 1 <= int(UC) <= len(Details):
                    table1 = Details[int(UC) - 1]
                    time.sleep(0.5)
                    super()._ClearTerminal()
                    Flag = True
                else:
                    super()._ClearTerminal()
                    print("Invalid input")
                    time.sleep(1)
            elif UC == "X":
                super()._ClearTerminal()
                Flag = True
                self.ChoosingDataBaseLocation(host, UserName, Password, Admin)
            else:
                super()._ClearTerminal()
                print("Invalid input")
                time.sleep(1)
        return table1

    def _ChoosingSensorTable(self, host, database, UserName, Password, Admin):
        table2 = ""
        Flag = False
        while Flag == False:
            super()._ClearTerminal()
            SQL = "SELECT DISTINCT TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = " + "'" + functools.reduce(
                operator.add, database) + "'" + ";"
            con = mysql.connector.connect(host=host, user=UserName, password=Password)
            cursor = con.cursor()
            cursor.execute(SQL)
            Details = cursor.fetchall()
            for i in range(0, len(Details)):
                print(str(i + 1) + ") " + functools.reduce(operator.add, Details[i]))
            cursor.close()
            con.close()
            UC = input("Choose table for Sensor data to be taken from or type X to return to previous page: ")
            if UC.isnumeric() == True:
                if 1 <= int(UC) <= len(Details):
                    table2 = Details[int(UC) - 1]
                    time.sleep(0.5)
                    super()._ClearTerminal()
                    Flag = True
                else:
                    super()._ClearTerminal()
                    print("Invalid input")
                    time.sleep(1)
            elif UC == "X":
                super()._ClearTerminal()
                Flag = True
                self._ChoosingGPSTable(host, database, UserName, Password, Admin)
            else:
                super()._ClearTerminal()
                print("Invalid input")
                time.sleep(1)
        return table2

    def ChoosingDataBaseLocation(self, host, UserName, Password, Admin):
        Flag = False
        if Admin == 1:
            super()._ClearTerminal()
            con = mysql.connector.connect(host=host, user=UserName, password=Password)
            cursor = con.cursor()
            SQL = "SELECT DISTINCT TABLE_SCHEMA FROM INFORMATION_SCHEMA.COLUMNS;"
            cursor.execute(SQL)
            Details = cursor.fetchall()
            while Flag == False:
                super()._ClearTerminal()
                for i in range(0, len(Details)):
                    print(str(i + 1) + ") " + functools.reduce(operator.add, Details[i]))
                cursor.close()
                con.close()
                UC = input("Choose database for data to be taken from: ")
                if UC.isnumeric() == True:
                    if 1 <= int(UC) <= len(Details):
                        database = Details[int(UC) - 1]
                        time.sleep(0.5)
                        super()._ClearTerminal()
                        Flag = True
                    else:
                        super()._ClearTerminal()
                        print("Invalid input")
                        time.sleep(1)
                else:
                    super()._ClearTerminal()
                    print("Invalid input")
                    time.sleep(1)
            table1 = self._ChoosingGPSTable(host, database, UserName, Password, Admin)
            table2 = self._ChoosingSensorTable(host, database, UserName, Password, Admin)
            DataLocation = [database, table1, table2]
            time.sleep(0.5)
            super()._ClearTerminal()
            return DataLocation

        elif Admin == 0:
            SQL = "Select Table_SCHEMA FROM information_schema.COLUMNS WHERE TABLE_NAME = 'SensorData' LIMIT 1"
            con = mysql.connector.connect(host=self.host, user=self.UserName, password=self.Password)
            cursor = con.cursor()
            cursor.execute(SQL)
            database = cursor.fetchall()
            cursor.close()
            con.close()
            table1 = "GPSData"
            table2 = "SensorData"
            DataLocation = [database, table1, table2]
            return DataLocation

def GetData(host, Username, Password, table1, table2, Database):
    Longitude = []
    Latitude = []
    TimeStamp1 = []
    TimeStamp2 = []
    AltitudeGPS = []
    NumOfSats = []
    GPSSpeed = []
    Temperature = []
    Acceleration = []
    Acceleration_X = []
    Acceleration_Y = []
    Acceleration_Z = []
    Pressure = []
    Humidity = []
    PressureAltitude = []
    Magnetometer = []
    Brightness = []
    Red_Light = []
    Green_Light = []
    Blue_Light = []
    x = time.time()
    SQL = "SELECT TimeStamp,Longitude,Latitude,GPSAltitude,NumOfSats,GPSSpeed FROM " + functools.reduce(operator.add,
                                                                                                        Database) + "." + functools.reduce(
        operator.add, table1) + " WHERE TimeStamp >= " + str(time.time() - 25) + " LIMIT 25"
    con = mysql.connector.connect(host=host, user=Username, password=Password)
    cursor = con.cursor()
    cursor.execute(SQL)
    data1 = cursor.fetchall()
    SQL = "SELECT TimeStamp,Temperature,Acceleration,Acceleration_X,Acceleration_Y,Acceleration_Z,Pressure,Humidity,PressureAltitude,Magnetometer,Brightness,Red_Light,Green_Light,Blue_Light FROM " + functools.reduce(
        operator.add, Database) + "." + functools.reduce(operator.add, table2) + " WHERE TimeStamp >= " + str(
        time.time() - 25) + " LIMIT 25"
    con = mysql.connector.connect(host=host, user=Username, password=Password)
    cursor = con.cursor()
    cursor.execute(SQL)
    data2 = cursor.fetchall()
    for i in data1:
        TimeStamp1.append(i[0])
        Longitude.append(i[1])
        Latitude.append(i[2])
        AltitudeGPS.append(i[3])
        NumOfSats.append(i[4])
        GPSSpeed.append(i[5])
    for i in data2:
        TimeStamp2.append(i[0])
        Temperature.append(i[1])
        Acceleration.append(i[2])
        Acceleration_X.append(i[3])
        Acceleration_Y.append(i[4])
        Acceleration_Z.append(i[5])
        Pressure.append(i[6])
        Humidity.append(i[7])
        PressureAltitude.append(i[8])
        Magnetometer.append(i[9])
        Brightness.append(i[10])
        Red_Light.append(i[11])
        Green_Light.append(i[12])
        Blue_Light.append(i[13])
    cursor.close()
    con.close()
    y = time.time()
    print("Data collection took " + str(y - x) + " seconds")
    return TimeStamp1, TimeStamp2, Longitude, Latitude, AltitudeGPS, NumOfSats, GPSSpeed, Temperature, Acceleration, Acceleration_X, Acceleration_Y, Acceleration_Z, Pressure, Humidity, PressureAltitude, Magnetometer, Brightness, Red_Light, Green_Light, Blue_Light

fig, a = plt.subplots(3, 6)
class Datagraphing():
    def __init__(self, host, Username, Password, Database, Table1, Table2):
        self.host = host
        self.Username = Username
        self.Password = Password
        self.Database = Database
        self.Table1 = Table1
        self.Table2 = Table2

    def animation(self, i):
        Graph_Details = {"Longitude": {"Title": "Longitude", "YLabel": ""},
                         "Latitude": {"Title": "Latitude", "YLabel": ""},
                         "Altitude": {"Title": "Altitude", "YLabel": "Metres"},
                         "NumOfSats": {"Title": "Number of Satellites", "YLabel": ""},
                         "GPSSpeed": {"Title": "Speed", "YLabel": "Metres per second"},
                         "Temperature": {"Title": "Temperature", "YLabel": "Degrees Celsius"},
                         "Acceleration": {"Title": "Acceleration", "YLabel": "Metres per second squared"},
                         "Acceleration_X": {"Title": "Acceleration X", "YLabel": "Metres per second squared"},
                         "Acceleration_Y": {"Title": "Acceleration Y", "YLabel": "Metres per second squared"},
                         "Acceleration_Z": {"Title": "Acceleration Z", "YLabel": "Metres per second squared"},
                         "Pressure": {"Title": "Pressure", "YLabel": "Hectopascals"},
                         "Humidity": {"Title": "Humidity", "YLabel": "Relative Humidity / %"},
                         "Pressure_Altitude": {"Title": "Pressure altitude", "YLabel": "Metres"},
                         "Magnetic_Field_Strength": {"Title": "Magnetic Field Strength", "YLabel": "MicroTesla"},
                         "Luminosity": {"Title": "Luminosity", "YLabel": "Amount of incident light"},
                         "Red_Light": {"Title": "Red Light", "YLabel": "Amount of incident red light"},
                         "Green_Light": {"Title": "Green Light", "YLabel": "Amount of incident green light"},
                         "Blue_Light": {"Title": "Blue Light", "YLabel": "Amount of incident blue light"}
                         }
        x = time.time()
        TimeStamp1, TimeStamp2, Longitude, Latitude, GPSAltitude, NumOfSats, GPSSpeed, Temperature, Acceleration, Acceleration_X, Acceleration_Y, Acceleration_Z, Pressure, Humidity, PressureAltitude, Magnetometer, Brightness, Red_Light, Green_Light, Blue_Light = GetData(
            self.host, self.Username, self.Password, self.Table1, self.Table2, self.Database)
        for i in range(0, 3):
            for j in range(0, 6):
                a[i, j].clear()

        for i in range(0, 3):
            for j in range(0, 6):
                a[i, j].get_xaxis().set_visible(False)

        a[0, 0].set_title(Graph_Details["Longitude"]["Title"])
        a[0, 1].set_title(Graph_Details["Latitude"]["Title"])
        a[0, 2].set_title(Graph_Details["Altitude"]["Title"])
        a[0, 3].set_title(Graph_Details["NumOfSats"]["Title"])
        a[0, 4].set_title(Graph_Details["GPSSpeed"]["Title"])
        a[0, 5].set_title(Graph_Details["Temperature"]["Title"])
        a[1, 0].set_title(Graph_Details["Acceleration"]["Title"])
        a[1, 1].set_title(Graph_Details["Acceleration_X"]["Title"])
        a[1, 2].set_title(Graph_Details["Acceleration_Y"]["Title"])
        a[1, 3].set_title(Graph_Details["Acceleration_Z"]["Title"])
        a[1, 4].set_title(Graph_Details["Pressure"]["Title"])
        a[1, 5].set_title(Graph_Details["Humidity"]["Title"])
        a[2, 0].set_title(Graph_Details["Pressure_Altitude"]["Title"])
        a[2, 1].set_title(Graph_Details["Magnetic_Field_Strength"]["Title"])
        a[2, 2].set_title(Graph_Details["Luminosity"]["Title"])
        a[2, 3].set_title(Graph_Details["Red_Light"]["Title"])
        a[2, 4].set_title(Graph_Details["Green_Light"]["Title"])
        a[2, 5].set_title(Graph_Details["Blue_Light"]["Title"])

        a[0, 2].set_ylabel(Graph_Details["Altitude"]["YLabel"])
        a[0, 4].set_ylabel(Graph_Details["GPSSpeed"]["YLabel"])
        a[0, 5].set_ylabel(Graph_Details["Temperature"]["YLabel"])
        a[1, 0].set_ylabel(Graph_Details["Acceleration"]["YLabel"])
        a[1, 1].set_ylabel(Graph_Details["Acceleration_X"]["YLabel"])
        a[1, 2].set_ylabel(Graph_Details["Acceleration_Y"]["YLabel"])
        a[1, 3].set_ylabel(Graph_Details["Acceleration_Z"]["YLabel"])
        a[1, 4].set_ylabel(Graph_Details["Pressure"]["YLabel"])
        a[1, 5].set_ylabel(Graph_Details["Humidity"]["YLabel"])
        a[2, 0].set_ylabel(Graph_Details["Pressure_Altitude"]["YLabel"])
        a[2, 1].set_ylabel(Graph_Details["Magnetic_Field_Strength"]["YLabel"])
        a[2, 2].set_ylabel(Graph_Details["Luminosity"]["YLabel"])
        a[2, 3].set_ylabel(Graph_Details["Red_Light"]["YLabel"])
        a[2, 4].set_ylabel(Graph_Details["Green_Light"]["YLabel"])
        a[2, 5].set_ylabel(Graph_Details["Blue_Light"]["YLabel"])

        a[0, 0].plot(TimeStamp1, Longitude, color='b')
        a[0, 1].plot(TimeStamp1, Latitude, color='b')
        a[0, 2].plot(TimeStamp1, GPSAltitude, color='b')
        a[0, 3].plot(TimeStamp1, NumOfSats, color='b')
        a[0, 4].plot(TimeStamp1, GPSSpeed, color='b')
        a[0, 5].plot(TimeStamp2, Temperature, color='b')
        a[1, 0].plot(TimeStamp2, Acceleration, color='b')
        a[1, 1].plot(TimeStamp2, Acceleration_X, color='b')
        a[1, 2].plot(TimeStamp2, Acceleration_Y, color='b')
        a[1, 3].plot(TimeStamp2, Acceleration_Z, color='b')
        a[1, 4].plot(TimeStamp2, Pressure, color='b')
        a[1, 5].plot(TimeStamp2, Humidity, color='b')
        a[2, 0].plot(TimeStamp2, PressureAltitude, color='b')
        a[2, 1].plot(TimeStamp2, Magnetometer, color='b')
        a[2, 2].plot(TimeStamp2, Brightness, color='b')
        a[2, 3].plot(TimeStamp2, Red_Light, color='b')
        a[2, 4].plot(TimeStamp2, Green_Light, color='b')
        a[2, 5].plot(TimeStamp2, Blue_Light, color='b')
        y = time.time()
        print("Plotting took " + str(y - x) + " seconds")
        print("Repeat at " + str(datetime.now()))


def StartUp():
    DetailsFinder = DataBaseLocation()
    LoginDetails = DetailsFinder.ConnectionFileReading()
    IDs = DetailsFinder.Login()
    DatabaseLocation = DetailsFinder.ChoosingDataBaseLocation(LoginDetails[0], LoginDetails[1], LoginDetails[2],
                                                              functools.reduce(operator.add, IDs[2]))
    fig, a = plt.subplots(3, 6)
    plt.subplots_adjust(left=0.07, bottom=0.076, right=0.9, top=0.9, wspace=0.6, hspace=0.445)
    Grapher = Datagraphing(LoginDetails[0], LoginDetails[1], LoginDetails[2], DatabaseLocation[0], DatabaseLocation[1],
                           DatabaseLocation[2])
    ani = FuncAnimation(fig, Grapher.animation, interval=200)
    plt.show()


StartUp()
